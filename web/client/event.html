<!doctype html>
<!--
    Name: Thomas Carpenter and Debralee Thompson
    Main Author: Debralee Thompson (24416186)
    Description: Specific event page for Charity Events Kempsey.
-->
<html lang="en-AU">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Event &#8212; Charity Events Kempsey</title>
        <link rel="stylesheet" href="styling.css">
    </head>
    <body>
        <!-- Nav -->
        <nav>
            <a class="logo" title="Charity Events Kempsey" href="/">Charity Events Kempsey</a>
            <div class="spacer"></div>
            <a title="Home" href="/">Home</a>
            <a title="Search Events" href="/search">Search Events</a>
        </nav>
        <!-- Nav Conclude -->

        <!-- Main Content -->
        <main>
            <!-- Event Details Section -->
            <section>
                <div class="event-detail">
                    <div class="event"></div>
                </div>
                <span class="warning"></span>

                <!--
                THIS HAS BEEN REPLACED WITH THE ACTIVE BUTTON GENERATED IN THE JAVASCRIPT BELOW
                This 'Register for Event' button is no longer hard-coded here. It is dynamically generated by the Javascript once the event is rendered, because its functionality depends on the event_id in the query string.
                 
                <button>Register for Event</button>
                -->
            </section>

            <!-- Registered Attendees Section -->
            <section id="attendees">
                <!-- Attendees list will be rendered here. -->
            </section>    
            
            <section>
                <button>Back to Events List</button>
            </section>
        </main>
        <!-- Main Content Conclude -->

        <!-- Footer -->
        <footer>
            <p>Copyright (c) Charity Events Kempsey. All rights reserved.</p>
            <p>Designed by Thomas Carpenter and Debralee Thompson for PROG2002 Assessment Task Three.</p>
            <p>Welcome Backdrop sourced under standard license from <a href="https://www.shutterstock.com/image-photo/kempsey-australia-494699236" target="_blank">Shutterstock</a>.</p>
        </footer>
        <!-- Footer Conclude -->
    
    <!-- Javascript -->
    <script>
        (function () {
            var eventDetail = document.querySelector(".event-detail .event");
            var warning = document.querySelector("span.warning");
            var buttonBack = document.querySelector("section button:nth-of-type(1)");
            
            /* THIS HAS BEEN REPLACED WITH THE ACTIVE BUTTON GENERATED IN THE JAVASCRIPT BELOW
            var buttonRegister = document.querySelector("section button:nth-of-type(2)");
            */

            if (buttonBack) {
                buttonBack.addEventListener("click", function () {
                    if (history.length > 1) {
                        history.back();
                    } 
                    else {
                        location.href = "search.html";
                    }
                });
            }

            /* THIS HAS BEEN REPLACED WITH THE ACTIVE BUTTON GENERATED IN THE JAVASCRIPT BELOW
            if (buttonRegister) {
                buttonRegister.addEventListener("click", function () {
                    alert("This feature is currently under construction, please check back soon!");
                });
            }
            */

            // Get event ID from query string.
            var uniqueEventID = new URLSearchParams(location.search).get("id");

            if (!uniqueEventID) {
                if (warning) {
                    warning.innerText = "Warning: Open this page from the home or search event pages.";
                }
                if (eventDetail) {
                    eventDetail.innerHTML = "";
                }
                return;
            }

            // Fetch event by unique ID.
            fetch("/api/events/" + encodeURIComponent(uniqueEventID))
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    var ev = Array.isArray(data)
                    ? data.find(function (row) { return String(row.event_id) === String(uniqueEventID); })
                    : data;
                    
                    if (!ev) {
                        if (warning) {
                            warning.innerText = "We could not find that event. Please return to Home or Search and try again.";
                        }
                        if (eventDetail) {
                            eventDetail.innerHTML = "";
                        }
                        return;
                    }

                    // Inline AU date formatting.
                    var startDT = ev.event_start_dt
                        ? new Date(ev.event_start_dt).toLocaleString("en-AU").replace(",", " at")
                        : "";
                    var endDT = ev.event_end_dt
                        ? new Date(ev.event_end_dt).toLocaleString("en-AU").replace(",", " at")
                        : "";

                    // Update document title.
                    document.title = ev.event_name + " â€” Charity Events Kempsey";

                    var ticketPrice = ev.ticket_price != null ? Number(ev.ticket_price) : null;
                    var goalAmount = ev.goal_amount != null ? Number(ev.goal_amount) : null;

                    // Render event in detail.
                    // Includes a new, dynamically generated & functioning 'Register for Event' link 
                    // (styled as a button). An <a> is used since the button is technically for navigation.
                    if (eventDetail) {
                        var eventHTML = `
                            <h3>${ev.event_name || "Event"}</h3>
                            <p><strong>${ev.category_name || "Event"}:</strong> Organised by ${ev.org_name || "Unknown"}</p>
                            <p>${ev.location_city || "Location TBC"}</p>
                            ${startDT ? `<p>Commences on the ${startDT}${endDT ? ` and concludes on the ${endDT}` : ""}</p>` : ""}
                            ${ev.event_desc ? `<p>${ev.event_desc}</p>` : ""}
                            ${ticketPrice !== null && !Number.isNaN(ticketPrice) ? `<p><strong>Ticket Price:</strong> $${ticketPrice.toFixed(2)}</p>` : ""}
                            ${goalAmount !== null && !Number.isNaN(goalAmount) ? `<p><strong>Goal Amount:</strong> $${goalAmount.toFixed(2)}</p>` : ""}
                            <div class="event-actions">
                                <a class="button" role="button" href="registration.html?id=${encodeURIComponent(uniqueEventID)}">Register for Event</a>
                            </div>
                        `;
                        eventDetail.innerHTML = eventHTML.trim();
                    }

                    if (warning) {
                        warning.innerText = "";
                    }

                    // Attendees Section
                    fetch("/api/registrations/" + encodeURIComponent(uniqueEventID))
                        .then(function (response) {
                            if (!response.ok) throw new Error("Failed to load attendees");
                            return response.json();
                        })
                        .then(function (attendees) {
                            var attendeesList = document.getElementById("attendees");

                            if (attendees.length === 0) {
                                attendeesList.innerHTML = `
                                    <p>No one has registered yet.</p>
                                `;
                                return;
                            }

                            var tableHTML = `
                                <h3>Registered Attendees</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Tickets</th>
                                            <th>Date Registered</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${attendees.map(a => `
                                            <tr>
                                                <td>${a.first_name} ${a.last_name}</td>
                                                <td>${a.contact_email}</td>
                                                <td>${a.contact_phone}</td>
                                                <td>${a.tickets_purchased}</td>
                                                <td>${new Date(a.registration_date).toLocaleDateString("en-AU")}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            `;
                            attendeesList.innerHTML = tableHTML;
                        })
                        .catch(function (err) {
                            console.error(err);
                            document.getElementById("attendees").innerHTML = "<p style='color:red;'>Could not load attendees.</p>";
                        });

                    // End of new attendees section                    

                })
                .catch(function () {
                    if (warning) {
                        warning.innerText = "Could not load event.";
                    }
                });
        })();
    </script>
    <!-- Javascript Conclude -->
    </body>
</html>
