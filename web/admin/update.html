<!doctype html>
<!--
    Name: Thomas Carpenter and Debralee Thompson
    Main Author: Thomas Carpenter (23636116)
    Description: Update Events page for Charity Events Kempsey.
-->
<html lang="en-AU">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Update Event &#8212; Admin Portal &#8212; Charity Events Kempsey</title>
        <link rel="stylesheet" href="../styling.css">
    </head>
    <body>
        <!-- Nav -->
        <nav>
            <a class="logo" title="Admin Portal &#8212; Charity Events Kempsey" href="admin.html">Admin Portal &#8212; Charity Events Kempsey</a>
            <div class="spacer"></div>
            <a title="Dashboard" href="admin.html">Dashboard</a>
            <a title="New Event" href="new.html">New Event</a>
        </nav>
        <!-- Nav Conclude -->

        <!-- Main Content -->
         <main>
            <section>
                <h2>Update Event</h2>
                <form id="update-event-form">
                    <fieldset>
                        <legend>Update form fields:</legend>
                        <!-- Event Name -->
                         <div class="form-row">
                            <label for="eventName">Event Name</label>
                            <input type="text" id="eventName" name="eventName" required>
                        </div>
                        <!-- Event Description -->
                        <div class="form-row">
                            <label for="eventDescription">Event Description</label>
                            <textarea id="eventDescription" name="eventDescription" rows="4" required></textarea>
                        </div>
                        <!-- Event Start Date and Time -->
                        <div class="form-row">
                            <label for="startDateTime">Event Start Date and Time</label>
                            <input type="datetime-local" id="startDateTime" name="startDateTime">
                        </div>
                        <!-- Event End Date and Time -->
                        <div class="form-row">
                            <label for="endDateTime">Event End Date and Time</label>
                            <input type="datetime-local" id="endDateTime" name="endDateTime">
                        </div>
                        <!-- Event City -->
                        <div class="form-row">
                            <label for="locationCity">Event City</label>
                            <input type="text" id="locationCity" name="locationCity" required>
                        </div>
                        <!-- Event State -->
                        <div class="form-row">
                            <label for="locationState">Event State</label>
                            <input type="text" id="locationState" name="locationState" required>
                        </div>
                        <!-- Event Postcode -->
                        <div class="form-row">
                            <label for="locationPostcode">Event Postcode</label>
                            <input type="text" id="locationPostcode" name="locationPostcode" required>
                        </div>
                    </fieldset>
                    <fieldset>
                        <!-- Submit Form -->
                        <input type="submit" name="submit" value="Update Event">
                    </fieldset>
                </form>
                <span class="warning"></span>
            </section>
         </main>
        <!-- Main Content Conclude -->

        <!-- Footer -->
        <footer>
            <p>Copyright (c) Charity Events Kempsey. All rights reserved.</p>
            <p>Designed by Thomas Carpenter and Debralee Thompson for PROG2002 Assessment Task Three.</p>
            <p>Welcome Backdrop sourced under standard license from <a href="https://www.shutterstock.com/image-photo/kempsey-australia-494699236" target="_blank">Shutterstock</a>.</p>
        </footer>
        <!-- Footer Conclude -->
    
    <!-- Javascript -->
    <script>
        var eventFormUpdate = document.getElementById("update-event-form");
        var warning = document.getElementsByClassName("warning")[0];
        // Retrieve Event ID to update.
        var uniqueEventID = new URLSearchParams(location.search).get("id");

        if(uniqueEventID === null) {
            warning.innerText = "No event has been selected for update. Please navigate back to the dashboard and try again."
            return;
        } else {
            // Retrieves values and fills the form in accordingly.
            fetch("/api/events/" + encodeURIComponent(uniqueEventID))
                .then(function (response) {
                    return response.json();
                })
                .then(function (event) {
                    if (event.error) {
                        warning.innerText = event.error;
                        return;
                    }
                    // Map form field ID names to the values in the Event database.
                    document.getElementById("eventName").value = event.event_name;
                    document.getElementById("eventDescription").value = event.event_desc;
                    document.getElementById("startDateTime").value = event.event_start_dt.replace('T',' ');
                    document.getElementById("endDateTime").value = event.event_end_dt.replace('T',' ');
                    document.getElementById("locationCity").value = event.location_city;
                    document.getElementById("locationState").value = event.location_state;
                    document.getElementById("locationPostcode").value = event.location_postcode;
                })
                .catch(function() {
                    warning.innerText = "Error loading event details, please try again."
                });
        }
        // Updating the form values.
        eventFormUpdate.addEventListener("submit", function (e) {
            e.preventDefault();
            var newUpdatedEvent = {
                event_name: document.getElementById("eventName").value,
                event_desc: document.getElementById("eventDescription").value,
                event_start_dt: document.getElementById("startDateTime").value.replace('T',' '),
                event_end_dt: document.getElementById("endDateTime").value.replace('T',' '),
                location_city: document.getElementById("locationCity").value,
                location_state: document.getElementById("locationState").value,
                location_postcode: document.getElementById("locationPostcode").value
            };
            fetch("/api/events" + encodeURIComponent(uniqueEventID), {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(newUpdatedEvent)
            })
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    alert("Event has been updated successfully with the new details.");
                    location.href = "admin.html";
                }
                else {
                    alert("Error updating event, please try again.");
                }
            })
            .catch(function() {
                alert("Error updating event, please try again.");
            });
        });
    </script>
    <!-- Javascript Conclude -->
    </body>
</html>